<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî –¢—é–ª—å–ø–∞–Ω03</title>
  <style>
    :root{
      --bg:#f7c1d9;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --brand:#E33478;
      --radius:16px;
      --stroke:#e5e7eb;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Inter,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    header{
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .logo{
      font-size:22px;
      font-weight:800;
    }

    .back-btn{
      display:inline-block;
      background:var(--brand);
      color:#fff;
      padding:8px 14px;
      border-radius:12px;
      text-decoration:none;
      font-weight:600;
      font-size:14px;
    }

    h1{
      margin:10px 0 16px;
      text-align:left;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      border:1px solid var(--stroke);
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      margin-bottom:20px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th, td{
      padding:8px;
      border-bottom:1px solid var(--stroke);
      text-align:left;
    }

    th:last-child, td:last-child{
      text-align:right;
    }

    .empty{
      padding:10px 0;
      color:var(--muted);
    }

    .total{
      margin-top:10px;
      font-size:18px;
      font-weight:700;
    }

    .btn{
      padding:10px 16px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:600;
      color:#fff;
      margin-right:10px;
      font-size:14px;
    }

    .whatsapp{background:#25D366;}
    .telegram{background:#229ED9;}
    .clear-btn{background:#ff4d4d;}

    .qty{
      width:80px;
      padding:6px;
      border-radius:10px;
      border:1px solid #ccc;
      text-align:center;
      font-size:14px;
    }

    .qty.invalid{
      border:2px solid red !important;
      background:#ffe6e6 !important;
    }

    @media(max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      table{
        font-size:13px;
      }
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <div class="logo">üå∑ –¢—é–ª—å–ø–∞–Ω03</div>
    <a href="catalog.html" class="back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
  </header>

  <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>

  <div class="card">
    <table id="cartTable">
      <thead>
        <tr>
          <th>–¢–æ–≤–∞—Ä</th>
          <th>–¢–∏–ø</th>
          <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</th>
          <th>–¶–µ–Ω–∞ –∑–∞ —à—Ç</th>
          <th>–°—É–º–º–∞</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="cartEmpty" class="empty" style="display:none;">
      –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç—é–ª—å–ø–∞–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.
    </div>

    <div class="total">–ò—Ç–æ–≥–æ: <span id="totalPrice">0 ‚ÇΩ</span></div>

    <div style="margin-top:12px;">
      <button class="btn whatsapp" type="button" onclick="sendWhatsApp()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</button>
      <button class="btn telegram" type="button" onclick="sendTelegram()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
      <button class="btn clear-btn" type="button" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>

</div>

<script>
  const CART_KEY = 'cart';
  const PACK = 20;

  // –≥—Ä–∞–¥–∞—Ü–∏—è –≥–ª–∞–¥–∫–∏–µ+–º–∏–∫—Å
  const tiersSmooth = [
    {min:20,   max:500,    price:99},
    {min:500,  max:1000,   price:88},
    {min:1000, max:2000,   price:80},
    {min:2000, max:3000,   price:79},
    {min:3000, max:5000,   price:78},
    {min:5000, max:10000,  price:77},
    {min:10000,max:50000,  price:76},
    {min:50000,max:1000000,price:75}
  ];

  // –≥—Ä–∞–¥–∞—Ü–∏—è –º–∞—Ö—Ä–æ–≤—ã–µ
  const tiersTerry = [
    {min:20,   max:500,    price:109},
    {min:500,  max:1000,   price:98},
    {min:1000, max:2000,   price:90},
    {min:2000, max:3000,   price:89},
    {min:3000, max:5000,   price:88},
    {min:5000, max:10000,  price:87},
    {min:10000,max:50000,  price:86},
    {min:50000,max:1000000,price:85}
  ];

  function getPriceByTiers(tiers, qty){
    for (const t of tiers){
      if (qty >= t.min && qty < t.max) return t.price;
    }
    return tiers[tiers.length-1].price;
  }

  function getCart(){
    const raw = localStorage.getItem(CART_KEY);
    if (!raw) return {};
    try{
      const parsed = JSON.parse(raw);
      // –æ–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç {id: {id,name,type,qty}}
      return parsed && typeof parsed === 'object' ? parsed : {};
    }catch(e){
      return {};
    }
  }

  function saveCart(cart){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function format(num){return num.toLocaleString('ru-RU');}

  function loadCart(){
    const cart = getCart();
    const tbody = document.querySelector('#cartTable tbody');
    const empty = document.getElementById('cartEmpty');
    const totalEl = document.getElementById('totalPrice');

    tbody.innerHTML = '';

    let hasItems = false;
    let total = 0;

    // —Å–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–µ–º –æ–±—â–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –≥—Ä–∞–¥–∞—Ü–∏–∏
    let smoothTotal = 0;
    let terryTotal  = 0;

    for (const id in cart){
      const item = cart[id];
      if (!item || !item.qty) continue;
      hasItems = true;
      if (item.type === 'terry') terryTotal += item.qty;
      else smoothTotal += item.qty; // –≥–ª–∞–¥–∫–∏–µ + –º–∏–∫—Å
    }

    const priceSmooth = getPriceByTiers(tiersSmooth, smoothTotal);
    const priceTerry  = getPriceByTiers(tiersTerry, terryTotal);

    // —Ç–µ–ø–µ—Ä—å —Ä–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–æ–∫–∏
    for (const id in cart){
      const item = cart[id];
      if (!item || !item.qty) continue;

      const unitPrice = (item.type === 'terry') ? priceTerry : priceSmooth;
      const sum = unitPrice * item.qty;
      total += sum;

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${item.name}</td>
          <td>${item.type === 'terry' ? '–ú–∞—Ö—Ä–æ–≤—ã–π' : (item.type === 'mix' ? '–ú–∏–∫—Å' : '–ì–ª–∞–¥–∫–∏–π')}</td>
          <td>
            <input
              type="number"
              class="qty"
              min="20"
              step="20"
              value="${item.qty}"
              oninput="highlightInvalid(this)"
              onblur="updateQty('${id}', this)"
            >
          </td>
          <td>${format(unitPrice)} ‚ÇΩ</td>
          <td>${format(sum)} ‚ÇΩ</td>
          <td><a href="#" onclick="removeItem('${id}');return false;">–£–¥–∞–ª–∏—Ç—å</a></td>
        </tr>
      `);
    }

    if (!hasItems){
      empty.style.display = 'block';
    } else {
      empty.style.display = 'none';
    }

    totalEl.textContent = format(total) + ' ‚ÇΩ';
  }

  function highlightInvalid(input){
    let v = parseInt(input.value);
    if (!v || v < PACK || v % PACK !== 0){
      input.classList.add('invalid');
    } else {
      input.classList.remove('invalid');
    }
  }

  function updateQty(id, input){
    let q = parseInt(input.value);

    if (!q || q < PACK) q = PACK;

    if (q % PACK !== 0){
      q = Math.round(q / PACK) * PACK;
    }
    if (q < PACK) q = PACK;

    input.value = q;
    input.classList.remove('invalid');

    const cart = getCart();
    if (cart[id]){
      cart[id].qty = q;
      saveCart(cart);
    }

    loadCart();
  }

  function removeItem(id){
    const cart = getCart();
    delete cart[id];
    saveCart(cart);
    loadCart();
  }

  function clearCart(){
    localStorage.removeItem(CART_KEY);
    loadCart();
  }

  function buildMessage(){
    const cart = getCart();
    let text = '–ó–∞–∫–∞–∑ —Ç—é–ª—å–ø–∞–Ω–æ–≤:\n';
    let total = 0;

    let smoothTotal = 0;
    let terryTotal  = 0;

    for (const id in cart){
      const item = cart[id];
      if (!item || !item.qty) continue;
      if (item.type === 'terry') terryTotal += item.qty;
      else smoothTotal += item.qty;
    }

    const priceSmooth = getPriceByTiers(tiersSmooth, smoothTotal);
    const priceTerry  = getPriceByTiers(tiersTerry, terryTotal);

    for (const id in cart){
      const item = cart[id];
      if (!item || !item.qty) continue;

      const unitPrice = (item.type === 'terry') ? priceTerry : priceSmooth;
      const sum = unitPrice * item.qty;
      total += sum;
      text += `${item.name} ‚Äî ${item.qty} —à—Ç √ó ${unitPrice} ‚ÇΩ = ${sum} ‚ÇΩ\n`;
    }

    text += `\n–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
    return text;
  }

  function sendWhatsApp(){
    const cart = getCart();
    if (!Object.keys(cart).length){
      alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
      return;
    }
    const msg = buildMessage();
    const url = 'https://wa.me/79148416115?text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
  }

  function sendTelegram(){
    const cart = getCart();
    if (!Object.keys(cart).length){
      alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
      return;
    }
    const msg = buildMessage();
    const url = 'https://t.me/share/url?url=&text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
  }

  loadCart();
</script>

</body>
</html>
