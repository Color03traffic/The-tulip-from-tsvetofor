<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Корзина — Тюльпан03</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
  <link rel="shortcut icon" type="image/png" href="favicon.png">

  <style>
    :root{
      --bg:#f7b3d0;
      --white:#ffffff;
      --text:#222;
      --muted:#666;
      --brand:#e33474;
      --radius:18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,Roboto,Arial,sans-serif;
      color:var(--text);
    }

    .container{
      max-width:900px;
      margin:40px auto;
      padding:20px;
      background:var(--white);
      border-radius:var(--radius);
    }

    h1{
      margin-top:0;
      font-size:30px;
      font-weight:700;
    }

    .muted{
      color:var(--muted);
      font-size:14px;
    }

    /* ---------- Новое: исправление мобильной таблицы ---------- */
    .table-wrapper{
      width:100%;
      overflow-x:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      min-width:650px; /* предотвращает сжатие на телефоне */
    }
    /* ----------------------------------------------------------- */

    th,td{
      padding:12px 10px;
      border-bottom:1px solid #ddd;
      text-align:left;
    }

    .qtyBox{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .qtyBox button{
      width:32px;
      height:32px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:18px;
    }

    .qtyBox input{
      width:60px;
      text-align:center;
      padding:6px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    .btn{
      padding:12px 20px;
      background:var(--brand);
      border-radius:10px;
      color:#fff;
      font-weight:600;
      border:none;
      cursor:pointer;
      display:inline-block;
      margin-top:20px;
      text-align:center;
    }

    .btnSecondary{
      background:#fff;
      border:2px solid var(--brand);
      color:var(--brand);
      margin-right:12px;
    }

    .btnGreen{ background:#25D366; }
    .btnBlue{ background:#229ED9; }

    .btn:hover{ opacity:0.9; }

    .totalBox{
      margin-top:20px;
      font-size:22px;
      font-weight:700;
    }

    /* ❌ УДАЛЁН ломавший адаптив (display:block) */
  </style>
</head>

<body>
<div class="container">

  <h1>Корзина</h1>
  <p class="muted">Количество кратно 20 шт. Нажмите «+» или «−» или измените вручную.</p>

  <!-- ОБЁРТКА ДЛЯ ТАБЛИЦЫ -->
  <div class="table-wrapper">
    <table id="cartTable">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Цена за шт.</th>
          <th>Количество</th>
          <th>Сумма</th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
  </div>

  <div class="totalBox">Итого: <span id="cartTotal">0 ₽</span></div>

  <p class="muted" id="summaryText"></p>

  <!-- Контакты -->
  <div style="margin-top:25px;">
    <h3>Данные для связи</h3>
    <label>ФИО</label>
    <input id="fio" type="text" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:8px;">
    <label>Телефон</label>
    <input id="phone" type="text" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:8px;">
  </div>

  <!-- Кнопки -->
  <div style="margin-top:25px;">
    <a href="catalog.html" class="btn btnSecondary">Вернуться в каталог</a>
    <button class="btn" onclick="clearCart()">Очистить корзину</button>
  </div>

  <div style="margin-top:25px;">
    <button class="btn btnGreen" onclick="sendWhatsApp()">Отправить в WhatsApp</button>
    <button class="btn btnBlue" onclick="sendTelegram()">Отправить в Telegram</button>
  </div>

</div>

<script>
/* ====== Градации ====== */
const tiersSmoothMix = [
  {min:20,max:499,price:99},
  {min:500,max:999,price:88},
  {min:1000,max:1999,price:80},
  {min:2000,max:2999,price:79},
  {min:3000,max:4999,price:78},
  {min:5000,max:9999,price:77},
  {min:10000,max:49999,price:76},
  {min:50000,max:99999,price:75}
];

const tiersTerry = [
  {min:20,max:499,price:109},
  {min:500,max:999,price:98},
  {min:1000,max:1999,price:90},
  {min:2000,max:2999,price:89},
  {min:3000,max:4999,price:88},
  {min:5000,max:9999,price:87},
  {min:10000,max:49999,price:86},
  {min:50000,max:99999,price:85}
];

function getPriceFromTiers(tiers,totalQty){
  for (const t of tiers){
    if (totalQty >= t.min && totalQty <= t.max) return t.price;
  }
  return tiers[tiers.length - 1].price;
}

function getUnitPrices(){
  const totalQty = cart.reduce((sum,i)=>sum+i.qty,0);
  return {
    priceSmoothMix: getPriceFromTiers(tiersSmoothMix,totalQty),
    priceTerry: getPriceFromTiers(tiersTerry,totalQty)
  };
}

/* ====== Корзина ====== */
let cart = JSON.parse(localStorage.getItem("tulpan03_cart") || "[]");
function saveCart(){ localStorage.setItem("tulpan03_cart", JSON.stringify(cart)); }

function normalizeQty(v){
  v = parseInt(v) || 20;
  if (v < 20) v = 20;
  return Math.round(v/20)*20;
}

function changeQty(i,delta){
  cart[i].qty = normalizeQty(cart[i].qty + delta);
  saveCart();
  updateCart();
}

function manualQtyChange(i,val){
  cart[i].qty = normalizeQty(val);
  saveCart();
  updateCart();
}

function clearCart(){
  localStorage.removeItem("tulpan03_cart");
  cart = [];
  updateCart();
}

function updateCart(){
  const body = document.getElementById("cartBody");
  const totalEl = document.getElementById("cartTotal");
  const summary = document.getElementById("summaryText");

  if(cart.length===0){
    body.innerHTML = "<tr><td colspan='4'>Корзина пуста.</td></tr>";
    totalEl.textContent = "0 ₽";
    summary.textContent = "";
    return;
  }

  const {priceSmoothMix,priceTerry} = getUnitPrices();
  let total = 0;
  let smoothQty = 0;
  let terryQty = 0;

  body.innerHTML = cart.map((item,index)=>{
    const unit = item.type==="terry" ? priceTerry : priceSmoothMix;
    const sum = unit*item.qty;

    total += sum;
    if(item.type==="terry") terryQty += item.qty;
    else smoothQty += item.qty;

    return `
      <tr>
        <td>${item.name}</td>
        <td>${unit} ₽</td>
        <td>
          <div class="qtyBox">
            <button onclick="changeQty(${index},-20)">−</button>
            <input type="number" value="${item.qty}" onchange="manualQtyChange(${index},this.value)">
            <button onclick="changeQty(${index},20)">+</button>
          </div>
        </td>
        <td>${sum} ₽</td>
      </tr>
    `;
  }).join("");

  totalEl.textContent = total + " ₽";

  summary.textContent =
    `Общий объём ${smoothQty+terryQty} шт (гладкие и микс: ${smoothQty} шт, махровые: ${terryQty} шт).
     Цена гладких и микса: ${priceSmoothMix} ₽, махровых: ${priceTerry} ₽.`;
}

/* ====== Формирование сообщений ====== */
function buildMessage(){
  const fio = document.getElementById("fio").value || "Не указано";
  const phone = document.getElementById("phone").value || "Не указано";

  let msg = `Заказ тюльпанов%0AФИО: ${fio}%0AТелефон: ${phone}%0A-----------------%0A`;

  cart.forEach(i=>{
    const {priceSmoothMix,priceTerry} = getUnitPrices();
    const unit = i.type==="terry" ? priceTerry : priceSmoothMix;
    const sum = unit*i.qty;
    msg += `${i.name}: ${i.qty} шт × ${unit} ₽ = ${sum} ₽%0A`;
  });

  msg += "-----------------%0AИтого: " + document.getElementById("cartTotal").textContent;

  return msg;
}

function sendWhatsApp(){
  window.location.href = "https://wa.me/79148416115?text=" + buildMessage();
}

function sendTelegram(){
  const text = buildMessage();
  window.location.href = "https://t.me/share/url?url=&text=" + text;
}

/* Init */
updateCart();
</script>

</body>
</html>
