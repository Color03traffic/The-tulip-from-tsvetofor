<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Корзина — Тюльпан03</title>

  <style>
    :root{
      --bg:#f7b3d0;
      --white:#ffffff;
      --text:#222;
      --muted:#666;
      --brand:#e33474;
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,Roboto,Arial,sans-serif;
      color:var(--text);
    }
    .container{
      max-width:900px;
      margin:40px auto;
      padding:20px;
      background:var(--white);
      border-radius:var(--radius);
    }
    h1{
      margin-top:0;
      font-size:30px;
      font-weight:700;
    }
    .muted{
      color:var(--muted);
      font-size:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    th,td{
      padding:12px 10px;
      border-bottom:1px solid #ddd;
      text-align:left;
    }
    .qtyBox{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .qtyBox button{
      width:32px;
      height:32px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:18px;
    }
    .qtyBox input{
      width:60px;
      text-align:center;
      padding:6px;
      border-radius:8px;
      border:1px solid #ccc;
    }
    .btn{
      padding:12px 20px;
      background:var(--brand);
      border-radius:10px;
      color:#fff;
      font-weight:600;
      border:none;
      cursor:pointer;
      display:inline-block;
      margin-top:20px;
      text-align:center;
    }
    .btn:hover{
      opacity:0.9;
    }
    .btnGreen{ background:#25D366; }
    .btnBlue{  background:#229ED9; }
    .btnSecondary{
      background:#fff;
      border:2px solid var(--brand);
      color:var(--brand);
      margin-right:12px;
    }
    .totalBox{
      margin-top:20px;
      font-size:22px;
      font-weight:700;
    }

    @media(max-width:600px){
      table,thead,tbody,tr,td,th{display:block;}
      td{border:none;}
      tr{
        margin-bottom:20px;
        border-bottom:1px solid #ddd;
        padding-bottom:10px;
      }
    }
  </style>
</head>

<body>
<div class="container">
  <h1>Корзина</h1>

  <p class="muted">Количество кратно 20 шт. Вы можете менять вручную.</p>

  <table id="cartTable">
    <thead>
      <tr>
        <th>Товар</th>
        <th>Цена за шт.</th>
        <th>Количество</th>
        <th>Сумма</th>
      </tr>
    </thead>
    <tbody id="cartBody"></tbody>
  </table>

  <div class="totalBox">
    Итого: <span id="cartTotal">0 ₽</span>
  </div>

  <div style="margin-top:25px;">
    <a href="catalog.html" class="btn btnSecondary">Вернуться в каталог</a>
    <button class="btn" onclick="clearCart()">Очистить корзину</button>
  </div>

  <div style="margin-top:25px;">
    <button class="btn btnGreen" onclick="sendWhatsApp()">Отправить в WhatsApp</button>
    <button class="btn btnBlue" onclick="sendTelegram()">Отправить в Telegram</button>
  </div>
</div>

<script>
/* === Градации цен — ВСЁ КАК БЫЛО === */
const tiersSmoothMix = [
  {min:20, max:499, price:99},
  {min:500, max:999, price:88},
  {min:1000, max:1999, price:80},
  {min:2000, max:2999, price:79},
  {min:3000, max:4999, price:78},
  {min:5000, max:9999, price:77},
  {min:10000, max:49999, price:76},
  {min:50000, max:99999, price:75}
];

const tiersTerry = [
  {min:20, max:499, price:109},
  {min:500, max:999, price:98},
  {min:1000, max:1999, price:90},
  {min:2000, max:2999, price:89},
  {min:3000, max:4999, price:88},
  {min:5000, max:9999, price:87},
  {min:10000, max:49999, price:86},
  {min:50000, max:99999, price:85}
];

function getPriceFromTiers(tiers, totalQty){
  for(const t of tiers){
    if(totalQty >= t.min && totalQty <= t.max) return t.price;
  }
  return tiers[tiers.length - 1].price;
}

function getUnitPrices(){
  const totalQty = cart.reduce((s,i)=>s+i.qty, 0);
  if(totalQty === 0) return {priceSmoothMix:0, priceTerry:0};
  return {
    priceSmoothMix: getPriceFromTiers(tiersSmoothMix, totalQty),
    priceTerry: getPriceFromTiers(tiersTerry, totalQty)
  };
}

/* === КОРЗИНА === */
let cart = JSON.parse(localStorage.getItem("tulpan03_cart") || "[]");

function saveCart(){ localStorage.setItem("tulpan03_cart", JSON.stringify(cart)); }

function normalizeQty(v){
  let q = parseInt(v,10) || 20;
  if(q < 20) q = 20;
  q = Math.round(q / 20) * 20;
  if(q < 20) q = 20;
  return q;
}

function updateCart(){
  const body = document.getElementById("cartBody");
  const totalEl = document.getElementById("cartTotal");

  if(cart.length === 0){
    body.innerHTML = "<tr><td colspan='4'>Корзина пуста.</td></tr>";
    totalEl.textContent = "0 ₽";
    return;
  }

  const {priceSmoothMix, priceTerry} = getUnitPrices();
  let total = 0;

  body.innerHTML = cart.map((item, index) => {
    const unit = (item.type === "terry") ? priceTerry : priceSmoothMix;
    const sum  = unit * item.qty;
    total += sum;

    return `
      <tr>
        <td>${item.name}</td>
        <td>${unit} ₽</td>
        <td>
          <div class="qtyBox">
            <button onclick="changeQty(${index}, -20)">−</button>
            <input type="number" value="${item.qty}" onchange="manualQtyChange(${index}, this.value)">
            <button onclick="changeQty(${index}, 20)">+</button>
          </div>
        </td>
        <td>${sum} ₽</td>
      </tr>
    `;
  }).join("");

  totalEl.textContent = total + " ₽";
}

function changeQty(i, delta){
  cart[i].qty = normalizeQty(cart[i].qty + delta);
  saveCart();
  updateCart();
}

function manualQtyChange(i, value){
  cart[i].qty = normalizeQty(value);
  saveCart();
  updateCart();
}

function clearCart(){
  cart = [];
  saveCart();
  updateCart();
}

/* === Формирование текста заказа === */
function buildMessage(){
  if(cart.length === 0) return "Корзина пуста";

  const {priceSmoothMix, priceTerry} = getUnitPrices();
  let total = 0;
  let msg = "Заказ тюльпанов:%0A-----------------%0A";

  cart.forEach(i => {
    const unit = (i.type === "terry") ? priceTerry : priceSmoothMix;
    const sum  = unit * i.qty;
    total += sum;

    msg += `${i.name}: ${i.qty} шт × ${unit} ₽ = ${sum} ₽%0A`;
  });

  msg += "-----------------%0AИтого: " + total + " ₽";
  return msg;
}

/* === WhatsApp — работает как раньше === */
function sendWhatsApp(){
  window.location.href = "https://wa.me/79148416115?text=" + buildMessage();
}

/* === Telegram — исправлено, работает на любых устройствах === */
/* Отправляем в @tulpan03 */
function sendTelegram(){
  const text = encodeURIComponent(buildMessage());
  const url  = "https://tulpan03.ru"; // просто чтобы не было пустым

  window.location.href =
    "https://t.me/share/url?url=" + encodeURIComponent(url) +
    "&text=" + text;
}

updateCart();
</script>

</body>
</html>
