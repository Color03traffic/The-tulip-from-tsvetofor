<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –¢—é–ª—å–ø–∞–Ω—ã –æ–ø—Ç–æ–º | –¢—é–ª—å–ø–∞–Ω03.—Ä—Ñ</title>
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="https://—Ç—é–ª—å–ø–∞–Ω03.—Ä—Ñ/catalog.html">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <meta name="theme-color" content="#E33400">
  <style>
    :root{ --bg:#E04297; --text:#111; --muted:#666; --brand:#E33400;
           --stroke:#e5e7eb; --radius:18px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Roboto,Inter,sans-serif;background:var(--bg);color:var(--text)}
    a{text-decoration:none;color:inherit}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--stroke);padding:12px 0;z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .spread{display:flex;justify-content:space-between;align-items:center}
    .logo{font-weight:800;font-size:22px}
    nav a{margin-left:14px;font-weight:500}
    nav a:hover{color:var(--brand)}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .btn:hover{opacity:.92}
    main.container, .section, footer{background:#fff;border-radius:var(--radius)}
    .section{padding:32px 20px;margin-top:16px}
    .lead{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
    .card{border:1px solid var(--stroke);border-radius:16px;overflow:hidden;background:#f9fafb}
    .card img{width:100%;height:220px;object-fit:cover}
    .card .body{padding:16px}
    .card strong{display:block;margin-bottom:4px}
    .meta{color:var(--muted);font-size:13px;margin-bottom:6px}
    .price{font-size:20px;font-weight:700;margin-top:8px;color:var(--brand)}
    .hint{font-size:12px;color:var(--muted)}
    .qty-ctrl{display:inline-flex;align-items:center;border:1px solid #ccc;border-radius:10px;overflow:hidden;margin:4px 0;background:#fff}
    .qty-ctrl button{border:0;background:#fff;font-size:18px;padding:6px 10px;cursor:pointer;line-height:1;color:var(--brand)}
    .qty-ctrl button:hover{background:#f8f8f8}
    .qty-ctrl input.qty{width:90px;text-align:center;border:0;border-left:1px solid #eee;border-right:1px solid #eee;height:34px}
    .cart{border:1px solid var(--stroke);border-radius:16px;overflow:hidden;background:#fff}
    .cart-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f8fafc;border-bottom:1px solid var(--stroke)}
    .cart-body{padding:0}
    .cart-empty{padding:16px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid var(--stroke);text-align:left;font-size:14px;background:#fff;vertical-align:top}
    th{font-weight:700}
    .cart-total{display:flex;justify-content:flex-end;gap:24px;padding:12px 16px;font-weight:800;background:#fff}
    .sub{color:var(--muted);font-size:12px}
    .link{color:var(--brand)}
    footer{border-top:1px solid var(--stroke);padding:16px 20px;text-align:center;color:var(--muted);font-size:14px;margin-top:16px}
    .btn-row{display:flex;gap:12px;flex-wrap:wrap;padding:12px 16px}
    .btn-wa{background:#25D366;border-color:#25D366}
    .btn-tg{background:#229ED9;border-color:#229ED9}
    .form-row{display:flex;flex-wrap:wrap;gap:10px;padding:12px 16px}
    .form-row input{flex:1 1 200px;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);pointer-events:none;transition:opacity .25s,transform .25s;max-width:90vw;z-index:9999;font-size:14px;line-height:1.35}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast .t-title{font-weight:700;margin-bottom:4px}
    .toast .t-sub{color:#ddd;font-size:12px}
    .toast .ok{margin-right:6px}
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ—Ä–æ–≥–∞ */
    .tierbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:12px 16px;background:#f6f7fb;border:1px solid var(--stroke);border-radius:12px;font-size:14px;margin:12px 0}
    .badge{display:inline-block;background:#eef2ff;border:1px solid #dbe3ff;border-radius:999px;padding:6px 10px}
    .strong{font-weight:700}
    .muted{color:#666}
  </style>
</head>
<body>

<header>
  <div class="container spread">
    <div class="logo">üå∑ –¢—é–ª—å–ø–∞–Ω03</div>
    <nav>
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="#catalog">–ö–∞—Ç–∞–ª–æ–≥</a>
      <a href="#cart">–ö–æ—Ä–∑–∏–Ω–∞</a>
    </nav>
  </div>
</header>

<main class="container">

  <section id="catalog" class="section">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç—é–ª—å–ø–∞–Ω–æ–≤</h1>

    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–∞–¥ –∫–∞—Ç–∞–ª–æ–≥–æ–º -->
    <div class="tierbar" id="catalogTier">
      <span class="badge">–í—Å–µ–≥–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ: <span id="cQty" class="strong">0</span> —à—Ç</span>
      <span class="badge">–ü–æ—Ä–æ–≥: <span id="cRange" class="strong">‚Äî</span> —à—Ç</span>
      <span class="badge">–ì–ª–∞–¥–∫–∏–µ: <span id="cDef" class="strong">‚Äî ‚ÇΩ</span></span>
      <span class="badge">–ú–∞—Ö—Ä–æ–≤—ã–µ: <span id="cMah" class="strong">‚Äî ‚ÇΩ</span></span>
      <span class="badge muted">–°–ª–µ–¥. –ø–æ—Ä–æ–≥: <span id="cNext" class="strong">‚Äî</span></span>
    </div>

    <p class="lead">
      –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∞—Ç–Ω–æ —É–ø–∞–∫–æ–≤–∫–µ: 20 —à—Ç. –¶–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É –∑–∞–≤–∏—Å–∏—Ç –æ—Ç <b>–æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ</b>.
      –ì–ª–∞–¥–∫–∏–µ –∏ –º–∞—Ö—Ä–æ–≤—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ –ø–æ –ø–æ—Ä–æ–≥—É, –Ω–æ —É –Ω–∏—Ö <b>—Å–≤–æ–∏ —Ü–µ–Ω—ã</b> –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞.
    </p>
    <div class="grid" id="grid"></div>
  </section>

  <section id="cart" class="section">
    <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ä–æ–≥–∞ –∏ —Ü–µ–Ω –Ω–∞–¥ –∫–æ—Ä–∑–∏–Ω–æ–π -->
    <div class="cart" style="margin-bottom:16px">
      <div id="tierBar" class="tierbar">
        <span class="badge">–í—Å–µ–≥–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ: <span id="tierQty" class="strong">0</span> —à—Ç</span>
        <span class="badge">–ü–æ—Ä–æ–≥: <span id="tierRange" class="strong">‚Äî</span> —à—Ç</span>
        <span class="badge">–ì–ª–∞–¥–∫–∏–µ: <span id="tierPriceDefault" class="strong">‚Äî ‚ÇΩ</span></span>
        <span class="badge">–ú–∞—Ö—Ä–æ–≤—ã–µ: <span id="tierPriceMah" class="strong">‚Äî ‚ÇΩ</span></span>
        <span class="badge muted">–°–ª–µ–¥. –ø–æ—Ä–æ–≥: <span id="tierNext" class="strong">‚Äî</span></span>
      </div>
    </div>

    <div class="cart" id="cartBox">
      <div class="cart-head">
        <div>–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</div>
        <button id="clearCart" class="btn" style="padding:8px 12px">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div class="cart-body">
        <div class="cart-empty" id="cartEmpty">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ <a class="link" href="#catalog">–∫–∞—Ç–∞–ª–æ–≥–∞</a>.</div>
        <div id="cartTableWrap" style="display:none">
          <table id="cartTable">
            <thead>
              <tr>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–¶–µ–Ω–∞ –∑–∞ —à—Ç</th>
                <th>–°—É–º–º–∞</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="cart-total">
            <div>–ò—Ç–æ–≥–æ:</div>
            <div id="cartTotal">0 ‚ÇΩ</div>
          </div>

          <div class="form-row">
            <input id="fio" type="text" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" required>
            <input id="phone" type="tel" placeholder="+7 (9XX) XXX-XX-XX" inputmode="tel" autocomplete="tel" required>
          </div>

          <div class="btn-row">
            <a id="waCheckout" class="btn btn-wa" target="_blank" rel="noopener">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</a>
            <a id="tgCheckout" class="btn btn-tg" href="https://t.me/share/url" target="_blank" rel="noopener">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="contacts" class="section">
    <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
    <p>üìç –£–ª–∞–Ω-–£–¥—ç, —É–ª. –¢–æ–±–æ–ª—å—Å–∫–∞—è, 167–ê<br>
      ‚òé <a href="tel:+79148416115">+7 914 841-61-15</a><br>
      üí¨ <a href="https://t.me/tulpan03" target="_blank">Telegram</a> ¬∑
      <a href="https://wa.me/79148416115" target="_blank">WhatsApp</a></p>
  </section>

</main>

<footer>
  ¬© 2025 –¢—é–ª—å–ø–∞–Ω03.—Ä—Ñ ‚Äî —Å–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã –æ–ø—Ç–æ–º üå∑
</footer>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
  <div class="t-title"><span class="ok">‚úÖ</span>–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
  <div class="t-sub" id="toastText">–ü–æ–∑–∏—Ü–∏—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
</div>

<script>
/* –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã */
const WA_PHONE="79148416115", PACK=20;

/* –î–∏–∞–ø–∞–∑–æ–Ω—ã ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, –Ω–æ —Ä–∞–∑–Ω—ã–µ —Ü–µ–Ω—ã */
const tiersDefault = [
  {min:20,   max:500,    price:99},
  {min:500,  max:1000,   price:88},
  {min:1000, max:2000,   price:80},
  {min:2000, max:3000,   price:79},
  {min:3000, max:5000,   price:78},
  {min:5000, max:10000,  price:77},
  {min:15000,max:50000,  price:76},
  {min:50000,max:100000, price:75}
];
const tiersMahrovye = [
  {min:20,   max:500,    price:109},
  {min:500,  max:1000,   price:98},
  {min:1000, max:2000,   price:90},
  {min:2000, max:3000,   price:89},
  {min:3000, max:5000,   price:88},
  {min:5000, max:10000,  price:87},
  {min:15000,max:50000,  price:86},
  {min:50000,max:100000, price:85}
];

/* –¢–æ–≤–∞—Ä—ã: type 'default' (–≥–ª–∞–¥–∫–∏–µ) | 'mahrovye' */
const products=[
  {id:"yellow",   name:"–ñ—ë–ª—Ç—ã–π",            type:"default",  img:"yellow.jpg"},
  {id:"white",    name:"–ë–µ–ª—ã–π",             type:"default",  img:"white.jpg"},
  {id:"cream",    name:"–ö—Ä–µ–º–æ–≤—ã–π",          type:"default",  img:"cream.jpg"},
  {id:"pink",     name:"–†–æ–∑–æ–≤—ã–π",           type:"default",  img:"pink.jpg"},
  {id:"red",      name:"–ö—Ä–∞—Å–Ω—ã–π",           type:"default",  img:"red.jpg"},
  {id:"roz-sir",  name:"–†–æ–∑–æ–≤–æ-—Å–∏—Ä–µ–Ω–µ–≤—ã–π",  type:"default",  img:"rozovo-sirenevyj.jpg"},
  {id:"bel-sir",  name:"–ë–µ–ª–æ-—Å–∏—Ä–µ–Ω–µ–≤—ã–π",    type:"default",  img:"belo-sirenevyj.jpg"},
  {id:"orange",   name:"–û—Ä–∞–Ω–∂–µ–≤—ã–π",         type:"default",  img:"orange.jpg"},
  {id:"red-yel",  name:"–ö—Ä–∞—Å–Ω–æ-–∂—ë–ª—Ç—ã–π",     type:"default",  img:"krasno-zheltyj.jpg"},
  {id:"kra-bel",  name:"–ö—Ä–∞–µ–≤–æ-–±–µ–ª—ã–π",      type:"default",  img:"kraevo-belyj.jpg"},
  {id:"violet",   name:"–§–∏–æ–ª–µ—Ç–æ–≤—ã–π",        type:"default",  img:"fioletovyj.jpg"},
  {id:"bel-roz",  name:"–ë–µ–ª–æ-—Ä–æ–∑–æ–≤—ã–π",      type:"default",  img:"belo-rozovyj.jpg"},
  {id:"mah-yel",  name:"–ú–∞—Ö—Ä–æ–≤—ã–π –∂—ë–ª—Ç—ã–π",   type:"mahrovye", img:"mahrovyj-zheltyj.jpg"},
  {id:"mah-pnk",  name:"–ú–∞—Ö—Ä–æ–≤—ã–π —Ä–æ–∑–æ–≤—ã–π",  type:"mahrovye", img:"mahrovyj-rozovyj.jpg"}
];

/* –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ */
const grid=document.getElementById('grid');
grid.innerHTML=products.map(p=>`
  <div class="card">
    <img src="${p.img}" alt="${p.name}">
    <div class="body">
      <strong>${p.name}</strong>
      <div class="meta">–¶–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ</div>
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç, –∫—Ä–∞—Ç–Ω–æ ${PACK}):</label>
      <div class="qty-ctrl">
        <button data-act="dec" data-id="${p.id}">‚àí</button>
        <input type="number" min="${PACK}" step="${PACK}" value="${PACK}" class="qty" data-id="${p.id}" data-type="${p.type}">
        <button data-act="inc" data-id="${p.id}">+</button>
      </div>
      <div class="price" data-price-for="${p.id}">‚Äî ‚ÇΩ</div>
      <div class="sub">1 —É–ø. = ${PACK} —à—Ç</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É¬ª</div>
      <div style="margin-top:10px">
        <button class="btn add" data-id="${p.id}">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  </div>
`).join('');

/* –ö–æ—Ä–∑–∏–Ω–∞ */
const cart = new Map(); // id -> {id,name,type,qty}

/* –£—Ç–∏–ª–∏—Ç—ã */
function roundToPacks(q){ if(!q) return PACK; q=Math.max(PACK,parseInt(q)||PACK); return Math.ceil(q/PACK)*PACK; }
function totalQtyCart(){ let t=0; cart.forEach(i=> t+=i.qty); return t; }
function findTierIndex(total){
  const base=tiersDefault;
  for(let i=0;i<base.length;i++){
    if(total>=base[i].min && total<=base[i].max) return i; // –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
  }
  return base.length-1;
}
function getUnitPriceByType(type,totalQty){
  const idx = findTierIndex(Math.max(totalQty, PACK));
  return (type==='mahrovye'? tiersMahrovye[idx].price : tiersDefault[idx].price);
}
function nextThresholdInfo(total){
  const idx = findTierIndex(Math.max(total, PACK));
  const nextIdx = idx+1;
  const base=tiersDefault;
  if(nextIdx>=base.length) return {label:'–º–∞–∫—Å. –ø–æ—Ä–æ–≥', left:0, hasNext:false};
  const nextMin = base[nextIdx].min;
  const left = Math.max(0, nextMin - total);
  return {label:`${nextMin} —à—Ç`, left, hasNext:true};
}
function money(n){ return Math.round(n).toLocaleString('ru-RU')+' ‚ÇΩ'; }

/* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ */
const tierQtyEl = document.getElementById('tierQty');
const tierRangeEl = document.getElementById('tierRange');
const tierPriceDefEl = document.getElementById('tierPriceDefault');
const tierPriceMahEl = document.getElementById('tierPriceMah');
const tierNextEl = document.getElementById('tierNext');

const cQtyEl = document.getElementById('cQty');
const cRangeEl = document.getElementById('cRange');
const cDefEl = document.getElementById('cDef');
const cMahEl = document.getElementById('cMah');
const cNextEl = document.getElementById('cNext');

function updateTierBars(){
  const total = totalQtyCart();
  const idx = findTierIndex(Math.max(total, PACK));
  const range = `${tiersDefault[idx].min}‚Äì${tiersDefault[idx].max}`;
  const def = getUnitPriceByType('default', total) + ' ‚ÇΩ';
  const mah = getUnitPriceByType('mahrovye', total) + ' ‚ÇΩ';
  const next = nextThresholdInfo(total);

  // –ë–∞—Ä –Ω–∞–¥ –∫–æ—Ä–∑–∏–Ω–æ–π
  tierQtyEl.textContent = total.toLocaleString('ru-RU');
  tierRangeEl.textContent = range;
  tierPriceDefEl.textContent = def;
  tierPriceMahEl.textContent = mah;
  tierNextEl.textContent = next.hasNext ? `${next.label} (–æ—Å—Ç–∞–ª–æ—Å—å ${next.left})` : '–º–∞–∫—Å. –ø–æ—Ä–æ–≥';

  // –ë–∞—Ä –Ω–∞–¥ –∫–∞—Ç–∞–ª–æ–≥–æ–º
  cQtyEl.textContent = total.toLocaleString('ru-RU');
  cRangeEl.textContent = range;
  cDefEl.textContent = def;
  cMahEl.textContent = mah;
  cNextEl.textContent = next.hasNext ? `${next.label} (–æ—Å—Ç–∞–ª–æ—Å—å ${next.left})` : '–º–∞–∫—Å. –ø–æ—Ä–æ–≥';
}

/* –ü–µ—Ä–µ—Å—á—ë—Ç —Ü–µ–Ω –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∏ –∫–æ—Ä–∑–∏–Ω–µ */
function refreshPricesEverywhere(){
  const total = totalQtyCart();

  // –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
  document.querySelectorAll('.card').forEach(card=>{
    const inp = card.querySelector('input.qty');
    const type = inp.dataset.type;
    const priceEl = card.querySelector('.price');
    const unit = getUnitPriceByType(type, total);
    priceEl.textContent = unit + ' ‚ÇΩ';
  });

  // –∫–æ—Ä–∑–∏–Ω–∞ ‚Äî –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –ø–æ —Å–≤–æ–µ–º—É —Ç–∏–ø—É
  const tbody=document.querySelector('#cartTable tbody');
  const totalEl=document.getElementById('cartTotal');
  if(cart.size===0){ totalEl.textContent='0 ‚ÇΩ'; updateTierBars(); return; }

  let grand=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    const id=tr.dataset.id;
    const item=cart.get(id); if(!item) return;
    const unit = getUnitPriceByType(item.type, total);
    const sum = unit * item.qty;
    tr.querySelector('[data-cell="unit"]').textContent = unit + ' ‚ÇΩ';
    tr.querySelector('[data-cell="sum"]').textContent  = money(sum);
    grand += sum;
  });
  totalEl.textContent = money(grand);

  updateTierBars();
}

/* –†–µ–Ω–¥–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã */
function renderCart(){
  const empty=document.getElementById('cartEmpty');
  const wrap=document.getElementById('cartTableWrap');
  const tbody=document.querySelector('#cartTable tbody');

  if(cart.size===0){
    empty.style.display='block'; wrap.style.display='none'; tbody.innerHTML='';
    refreshPricesEverywhere();
    return;
  }
  empty.style.display='none'; wrap.style.display='block'; tbody.innerHTML='';

  cart.forEach(item=>{
    const packs=item.qty/PACK;
    const tr=document.createElement('tr');
    tr.dataset.id=item.id;
    tr.innerHTML=`
      <td>${item.name}<div class="sub">${item.type==='mahrovye'?'–ú–∞—Ö—Ä–æ–≤—ã–µ':'–ì–ª–∞–¥–∫–∏–µ'}. –£–ø–∞–∫–æ–≤–æ–∫: ${packs}</div></td>
      <td>
        <div class="qty-ctrl">
          <button data-cart-act="dec" data-id="${item.id}">‚àí</button>
          <input type="number" min="${PACK}" step="${PACK}" value="${item.qty}" class="qty cart-qty" data-id="${item.id}">
          <button data-cart-act="inc" data-id="${item.id}">+</button>
        </div>
        <div class="sub">(${packs}√ó${PACK})</div>
      </td>
      <td data-cell="unit">‚Äî ‚ÇΩ</td>
      <td data-cell="sum">‚Äî ‚ÇΩ</td>
      <td><a href="#" class="link" data-act="del" data-id="${item.id}">–£–¥–∞–ª–∏—Ç—å</a></td>
    `;
    tbody.appendChild(tr);
  });

  refreshPricesEverywhere();
}

/* –¢–æ—Å—Ç */
const toast=document.getElementById('toast');
const toastText=document.getElementById('toastText');
let toastTimer=null;
function showToast(text){
  toastText.textContent=text;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove('show'), 2500);
}

/* –ö–∞—Ç–∞–ª–æ–≥: –≤–≤–æ–¥ –∏ +/‚àí (—Ç–æ–ª—å–∫–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º) */
document.addEventListener('input',e=>{
  const inp=e.target.closest('input.qty:not(.cart-qty)'); if(!inp) return;
  inp.value=roundToPacks(inp.value);
});
document.addEventListener('click',e=>{
  const btn=e.target.closest('button[data-act]'); if(!btn) return;
  const input=document.querySelector(`input.qty[data-id="${btn.dataset.id}"]`);
  let val=roundToPacks(input.value);
  if(btn.dataset.act==='inc') val+=PACK; else val=Math.max(PACK,val-PACK);
  input.value=val;
});

/* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É */
document.addEventListener('click',e=>{
  const add=e.target.closest('.add'); if(!add) return;
  const id=add.dataset.id;
  const p=products.find(x=>x.id===id);
  const input=document.querySelector(`.qty[data-id="${id}"]`);
  let qty=roundToPacks(input.value);
  const prev=cart.get(id)||{id,name:p.name,type:p.type,qty:0};
  prev.qty+=qty; cart.set(id,prev);
  renderCart();
  const packs=qty/PACK;
  showToast(`${p.name} ‚Äî ${qty} —à—Ç (${packs} —É–ø.)`);
});

/* –ö–æ—Ä–∑–∏–Ω–∞: +/‚àí, –≤–≤–æ–¥, —É–¥–∞–ª–∏—Ç—å, –æ—á–∏—Å—Ç–∏—Ç—å */
document.getElementById('cartBox').addEventListener('click',e=>{
  const del=e.target.closest('[data-act="del"]');
  if(del){ e.preventDefault(); cart.delete(del.dataset.id); renderCart(); return; }

  const btn=e.target.closest('button[data-cart-act]');
  if(btn){
    const id=btn.dataset.id;
    const it=cart.get(id); if(!it) return;
    if(btn.dataset.cartAct==='inc') it.qty+=PACK; else it.qty=Math.max(PACK,it.qty-PACK);
    cart.set(id,it);
    renderCart();
  }
});
document.getElementById('cartBox').addEventListener('input',e=>{
  const inp=e.target.closest('input.cart-qty'); if(!inp) return;
  const id=inp.dataset.id; const it=cart.get(id); if(!it) return;
  it.qty=roundToPacks(inp.value); if(it.qty<PACK) it.qty=PACK;
  cart.set(id,it);
  refreshPricesEverywhere();
});
document.getElementById('clearCart').addEventListener('click',()=>{ cart.clear(); renderCart(); });

/* –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ + –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ */
const fioInput=document.getElementById('fio'), phoneInput=document.getElementById('phone');
function formatPhone(value){
  let d=value.replace(/\D/g,'');
  if(d.startsWith('8')) d='7'+d.slice(1);
  if(!d.startsWith('7')) d='7'+d;
  d=d.slice(0,11);
  let res='+7';
  if(d.length>1) res+=' ('+d.slice(1,4);
  if(d.length>=4) res+=') '+d.slice(4,7);
  if(d.length>=7) res+='-'+d.slice(7,9);
  if(d.length>=9) res+='-'+d.slice(9,11);
  return res;
}
function saveField(k,v){try{localStorage.setItem(k,v);}catch(e){}}
function loadField(k){try{return localStorage.getItem(k)||'';}catch(e){return'';}}

phoneInput.addEventListener('input',()=>{
  phoneInput.value=formatPhone(phoneInput.value);
  saveField('t03_phone',phoneInput.value);
  phoneInput.setSelectionRange(phoneInput.value.length,phoneInput.value.length);
});
fioInput.addEventListener('input',()=>saveField('t03_fio',fioInput.value));
(function preload(){
  const sf=loadField('t03_fio'); const sp=loadField('t03_phone');
  if(sf) fioInput.value=sf; if(sp) phoneInput.value=sp;
})();

/* –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ */
function buildMsg(){
  if(cart.size===0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return null; }
  const fio=fioInput.value.trim();
  const digits=phoneInput.value.replace(/\D/g,'');
  if(!fio){ alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return null; }
  if(digits.length!==11){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω'); return null; }

  const total = totalQtyCart();
  const idx = findTierIndex(Math.max(total, PACK));

  let totalPacks=0, totalSum=0, lines=[];
  cart.forEach(i=>{
    const unit = (i.type==='mahrovye'? tiersMahrovye[idx].price : tiersDefault[idx].price);
    const pk=i.qty/PACK; totalPacks+=pk;
    const sum = unit*i.qty; totalSum+=sum;
    lines.push(`${i.name}: ${i.qty} —à—Ç (${pk} —É–ø. √ó ${PACK}) √ó ${unit} ‚ÇΩ = ${sum.toLocaleString('ru-RU')} ‚ÇΩ`);
  });

  const pretty=formatPhone('+'+digits);
  const header=`–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ —Å —Ç—é–ª—å–ø–∞–Ω03.—Ä—Ñ`;
  const footer=`–ò—Ç–æ–≥–æ: ${totalSum.toLocaleString('ru-RU')} ‚ÇΩ%0A–í—Å–µ–≥–æ —É–ø–∞–∫–æ–≤–æ–∫: ${totalPacks}%0A%0A–§–ò–û: ${encodeURIComponent(fio)}%0A–¢–µ–ª–µ—Ñ–æ–Ω: ${encodeURIComponent(pretty)}`;

  return encodeURI(header)+'%0A%0A'+lines.map(encodeURIComponent).join('%0A')+'%0A%0A'+footer;
}

/* WhatsApp */
document.getElementById('waCheckout').addEventListener('click',e=>{
  const msg=buildMsg(); if(!msg){e.preventDefault();return;}
  e.target.href=`https://wa.me/${WA_PHONE}?text=${msg}`;
});

/* Telegram ‚Äî deep-link + fallback –Ω–∞ share/url */
document.getElementById('tgCheckout').addEventListener('click',(e)=>{
  const msg=buildMsg(); if(!msg){e.preventDefault();return;}
  const tgShare=`https://t.me/share/url?text=${msg}`;
  const deep=`tg://msg?text=${msg}`;
  let fallbackTimer=null;
  const onVis=()=>{ if(document.hidden){ clearTimeout(fallbackTimer);} document.removeEventListener('visibilitychange',onVis); };
  document.addEventListener('visibilitychange',onVis);
  window.location.href=deep;
  fallbackTimer=setTimeout(()=>{ window.open(tgShare,'_blank','noopener'); },350);
  e.preventDefault();
});

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
function init(){ updateTierBars(); refreshPricesEverywhere(); }
init();
renderCart();
</script>

</body>
</html>
